@page
@model IdentityServer.Web.Pages.Account.ProfileModel
@{
    ViewData["Title"] = "My Profile";
    Layout = User.IsInRole("Admin") ? "_AdminLayout" : "_Layout";
}

<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                My Profile
            </h2>
        </div>
    </div>

    <div x-data="profileManager()" x-init="init()">
        <!-- Profile Information Card -->
        <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Profile Information</h3>

                <form @@submit.prevent="updateProfile()">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- First Name -->
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700">First Name</label>
                            <input type="text" id="firstName" x-model="profile.firstName" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>

                        <!-- Last Name -->
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700">Last Name</label>
                            <input type="text" id="lastName" x-model="profile.lastName" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>

                        <!-- Email -->
                        <div class="sm:col-span-2">
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" x-model="profile.email" disabled
                                class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm sm:text-sm">
                            <p class="mt-1 text-sm text-gray-500">Email cannot be changed from this page</p>
                        </div>

                        <!-- Phone Number -->
                        <div>
                            <label for="phoneNumber" class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <input type="tel" id="phoneNumber" x-model="profile.phoneNumber"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="submit"
                            class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Change Password Card -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Change Password</h3>

                <form @@submit.prevent="changePassword()">
                    <div class="space-y-4">
                        <!-- Current Password -->
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-700">Current Password</label>
                            <input type="password" id="currentPassword" x-model="passwordForm.currentPassword" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>

                        <!-- New Password -->
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
                            <input type="password" id="newPassword" x-model="passwordForm.newPassword" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <p class="mt-1 text-sm text-gray-500">Must be at least 8 characters with uppercase, lowercase, number and special character</p>
                        </div>

                        <!-- Confirm Password -->
                        <div>
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                            <input type="password" id="confirmPassword" x-model="passwordForm.confirmPassword" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="submit"
                            class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function profileManager() {
            return {
                profile: {
                    firstName: '@Model.FirstName',
                    lastName: '@Model.LastName',
                    email: '@Model.Email',
                    phoneNumber: '@Model.PhoneNumber'
                },
                passwordForm: {
                    currentPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                },

                init() {
                    // Profile data loaded from server-side model
                },

                async updateProfile() {
                    try {
                        const response = await fetch('/api/account/profile', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                            },
                            body: JSON.stringify(this.profile)
                        });

                        if (!response.ok) {
                            throw new Error('Failed to update profile');
                        }

                        if (window.showToast) {
                            window.showToast('Profile updated successfully', 'success');
                        } else {
                            alert('Profile updated successfully');
                        }
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        if (window.showToast) {
                            window.showToast('Failed to update profile', 'error');
                        } else {
                            alert('Failed to update profile');
                        }
                    }
                },

                async changePassword() {
                    if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
                        if (window.showToast) {
                            window.showToast('Passwords do not match', 'error');
                        } else {
                            alert('Passwords do not match');
                        }
                        return;
                    }

                    try {
                        const response = await fetch('/api/account/change-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                            },
                            body: JSON.stringify({
                                currentPassword: this.passwordForm.currentPassword,
                                newPassword: this.passwordForm.newPassword
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to change password');
                        }

                        if (window.showToast) {
                            window.showToast('Password changed successfully', 'success');
                        } else {
                            alert('Password changed successfully');
                        }

                        // Clear form
                        this.passwordForm = {
                            currentPassword: '',
                            newPassword: '',
                            confirmPassword: ''
                        };
                    } catch (error) {
                        console.error('Error changing password:', error);
                        if (window.showToast) {
                            window.showToast(error.message || 'Failed to change password', 'error');
                        } else {
                            alert(error.message || 'Failed to change password');
                        }
                    }
                }
            };
        }
    </script>
}
