@page
@model IdentityServer.Web.Pages.Admin.Clients.IndexModel
@{
    ViewData["Title"] = "OAuth Clients Management";
    Layout = "~/Pages/Admin/_AdminLayout.cshtml";
}

<div x-data="clientsManagement()" x-init="loadClients()">
    <!-- Page header -->
    <div class="sm:flex sm:items-center sm:justify-between mb-8">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900">OAuth Clients Management</h1>
            <p class="mt-2 text-sm text-gray-700">Manage OAuth 2.0 / OpenID Connect clients</p>
        </div>
        <div class="mt-4 sm:mt-0">
            <button type="button" @@click="openCreateModal()"
                class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                <svg class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Client
            </button>
        </div>
    </div>

    <!-- Clients Grid -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
        <template x-if="loading">
            <div class="col-span-3 flex justify-center py-12">
                <svg class="animate-spin h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </div>
        </template>

        <template x-for="client in clients" :key="client.id">
            <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div
                                class="flex-shrink-0 h-12 w-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                <svg class="h-6 w-6 text-primary-600" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25zm.75-12h9v9h-9v-9z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-medium text-gray-900" x-text="client.displayName"></h3>
                                <p class="text-sm text-gray-500" x-text="client.clientId"></p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Grant Types</p>
                            <div class="mt-1 flex flex-wrap gap-1">
                                <template x-for="grant in client.grantTypes" :key="grant">
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
                                        x-text="grant"></span>
                                </template>
                            </div>
                        </div>

                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Redirect URIs</p>
                            <template x-for="uri in client.redirectUris?.slice(0, 2)" :key="uri">
                                <p class="mt-1 text-xs text-gray-700 truncate" x-text="uri"></p>
                            </template>
                            <span x-show="client.redirectUris?.length > 2" class="text-xs text-gray-500"
                                x-text="`+${client.redirectUris.length - 2} more`"></span>
                        </div>

                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Scopes</p>
                            <div class="mt-1 flex flex-wrap gap-1">
                                <template x-for="scope in client.scopes?.slice(0, 3)" :key="scope">
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"
                                        x-text="scope"></span>
                                </template>
                                <span x-show="client.scopes?.length > 3"
                                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800"
                                    x-text="`+${client.scopes.length - 3}`"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button @@click="editClient(client)"
                            class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            Edit
                        </button>
                        <button @@click="deleteClient(client)"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent shadow-sm text-xs font-medium rounded text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Create/Edit Modal -->
    <div x-show="showModal" x-cloak class="fixed z-50 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
                x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @@click="closeModal()"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div x-show="showModal" x-transition:enter="ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave="ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-6">
                <div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6"
                        x-text="editingClient.id ? 'Edit OAuth Client' : 'Create New OAuth Client'"></h3>

                    <div class="space-y-4">
                        <!-- Client ID -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client ID *</label>
                            <input type="text" x-model="editingClient.clientId"
                                :disabled="editingClient.id !== undefined"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm disabled:bg-gray-100">
                        </div>

                        <!-- Display Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Display Name *</label>
                            <input type="text" x-model="editingClient.displayName"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                        </div>

                        <!-- Client Secret -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client Secret</label>
                            <input type="text" x-model="editingClient.clientSecret"
                                placeholder="Leave empty to auto-generate"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                            <p class="mt-1 text-xs text-gray-500">Leave empty to auto-generate a secure secret</p>
                        </div>

                        <!-- Grant Types -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Grant Types *</label>
                            <div class="space-y-2">
                                <template x-for="(grant, index) in availableGrantTypes" :key="index">
                                    <label class="inline-flex items-center mr-4">
                                        <input type="checkbox" :value="grant" x-model="editingClient.grantTypes"
                                            class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700" x-text="grant"></span>
                                    </label>
                                </template>
                            </div>
                        </div>

                        <!-- Redirect URIs -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Redirect URIs</label>
                            <template x-for="(uri, index) in editingClient.redirectUris" :key="index">
                                <div class="flex mb-2">
                                    <input type="text" x-model="editingClient.redirectUris[index]"
                                        class="flex-1 block border border-gray-300 rounded-l-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                                    <button @@click="editingClient.redirectUris.splice(index, 1)"
                                        class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 text-gray-500 hover:bg-gray-100">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <button @@click="editingClient.redirectUris.push('')"
                                class="mt-2 inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                + Add Redirect URI
                            </button>
                        </div>

                        <!-- Scopes -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Allowed Scopes</label>
                            <div class="space-y-2">
                                <template x-for="(scope, index) in availableScopes" :key="index">
                                    <label class="inline-flex items-center mr-4">
                                        <input type="checkbox" :value="scope" x-model="editingClient.scopes"
                                            class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700" x-text="scope"></span>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button type="button" @@click="saveClient()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:col-start-2 sm:text-sm">
                        Save
                    </button>
                    <button type="button" @@click="closeModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function clientsManagement() {
            return {
                clients: [],
                loading: false,
                showModal: false,
                editingClient: {},
                availableGrantTypes: [
                    'authorization_code',
                    'client_credentials',
                    'password',
                    'refresh_token',
                    'implicit'
                ],
                availableScopes: [
                    'openid',
                    'profile',
                    'email',
                    'offline_access',
                    'roles',
                    'api'
                ],

                async loadClients() {
                    this.loading = true;
                    try {
                        const response = await fetch('https://localhost:5001/api/admin/clients', {
                            credentials: 'include',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        this.clients = data || [];
                    } catch (error) {
                        console.error('Error loading clients:', error);
                        window.showToast('Failed to load OAuth clients', 'error');
                        this.clients = [];
                    } finally {
                        this.loading = false;
                    }
                },

                openCreateModal() {
                    this.editingClient = {
                        grantTypes: [],
                        redirectUris: [''],
                        scopes: []
                    };
                    this.showModal = true;
                },

                editClient(client) {
                    this.editingClient = JSON.parse(JSON.stringify(client));
                    this.showModal = true;
                },

                closeModal() {
                    this.showModal = false;
                    this.editingClient = {};
                },

                async saveClient() {
                    // Validation
                    if (!this.editingClient.clientId || !this.editingClient.displayName) {
                        window.showToast('Error', 'Client ID and Display Name are required', 'error');
                        return;
                    }

                    if (this.editingClient.grantTypes.length === 0) {
                        window.showToast('Error', 'At least one grant type must be selected', 'error');
                        return;
                    }

                    try {
                        // TODO: API call to save client
                        // const response = await fetch('/api/admin/clients', {
                        //     method: this.editingClient.id ? 'PUT' : 'POST',
                        //     headers: { 'Content-Type': 'application/json' },
                        //     body: JSON.stringify(this.editingClient)
                        // });

                        window.showToast('Success', this.editingClient.id ? 'Client updated successfully' : 'Client created successfully', 'success');
                        this.closeModal();
                        await this.loadClients();
                    } catch (error) {
                        console.error('Error saving client:', error);
                        window.showToast('Error', 'Failed to save client', 'error');
                    }
                },

                async deleteClient(client) {
                    if (!confirm(`Are you sure you want to delete client "${client.displayName}"?`)) return;

                    try {
                        const response = await fetch(`https://localhost:5001/api/admin/clients/${client.id}`, {
                            method: 'DELETE',
                            credentials: 'include',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to delete client');
                        }

                        window.showToast('Client deleted successfully', 'success');
                        await this.loadClients();
                    } catch (error) {
                        console.error('Error deleting client:', error);
                        window.showToast(error.message || 'Failed to delete client', 'error');
                    }
                    console.error('Error deleting client:', error);
                    window.showToast('Error', 'Failed to delete client', 'error');
                }
            }
        }
    </script>
}